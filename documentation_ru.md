# Документация к Telegram боту для чтения

## Обзор
Этот проект представляет собой Telegram бота, который помогает пользователям практиковать навыки чтения через интерактивные задания и вопросы. Бот генерирует тексты по различным темам, задает вопросы по содержанию и отслеживает прогресс пользователей.

## Функциональность
- Генерация текстов по различным образовательным темам
- Интерактивные викторины с вопросами с множественным выбором
- Отслеживание прогресса и статистики
- Система наград со звездами и значками
- Функция коллекционирования карточек
- Панель администратора с управлением пользователями и статистикой

## Установка

### Требования
- Python 3.8 или выше
- MongoDB
- Telegram Bot Token
- OpenAI API Key
- Google Gemini API Key (опционально)

### Шаги
1. Клонируйте репозиторий:
   ```
   git clone <url-репозитория>
   cd telegram-reading-bot
   ```

2. Создайте виртуальное окружение и активируйте его:
   ```
   python -m venv .venv
   .venv\Scripts\activate
   ```

3. Установите необходимые зависимости:
   ```
   pip install -r requirements.txt
   ```

4. Создайте файл `.env` в корневой директории со следующими переменными:
   ```
   TG_ADMIN_IDS=ваш_telegram_id
   TG_BOT_TOKEN=ваш_telegram_bot_token
   OPENAI_API_KEY=ваш_openai_api_key
   GOOGLE_GEMINI_API_KEY=ваш_google_gemini_api_key
   MONGODB_URI=mongodb://localhost:27017
   MONGODB_DB_NAME=telegram_bot
   ```

5. Запустите бота:
   ```
   python main.py
   ```

## Конфигурация
Поведение бота можно настроить через файл `core/config.py`:

- `DAILY_LIMIT_PER_THEME`: Максимальное количество вопросов по теме в день (по умолчанию: 5)
- `CARDS_PER_PAGE`: Количество карточек, отображаемых на странице (по умолчанию: 4)
- `MAX_ATTEMPTS`: Максимальное количество неправильных попыток на викторину (по умолчанию: 3)
- `MAX_RETRY`: Максимальное количество повторных попыток для API-вызовов (по умолчанию: 4)

Файл также содержит определения для:
- Тем для чтения, организованных по категориям
- Системы значков с различными уровнями достижений
- Меток значков для разных уровней

## Основные модули

### 1. Модуль обработки чтения (`handlers/reading/reading_main.py`)

#### Основные функции:
- `questions_handler` - Обрабатывает выбор темы пользователем и генерирует текст для чтения.
  - Проверяет, не превышен ли дневной лимит вопросов по выбранной теме
  - Генерирует текст и первый вопрос
  - Отправляет текст с защитой от копирования
  - Отображает первый вопрос с вариантами ответов

- `answer_handler` - Обрабатывает ответы пользователя на вопросы.
  - Проверяет правильность ответа
  - Обновляет статистику точности пользователя
  - При правильном ответе или превышении лимита ошибок завершает сессию
  - При неправильном ответе (если не превышен лимит ошибок) задает следующий вопрос

- `get_category_by_theme` - Вспомогательная функция для определения категории по теме.

### 2. Модуль обработки результатов чтения (`core/services/reading/reading_result.py`)

#### Основные функции:
- `save_card_and_notify` - Сохраняет результаты, начисляет звезды, уведомляет пользователя.
  - Логирует генерацию текста
  - Рассчитывает заработанные звезды и бонусы
  - Обновляет серию успешных ответов пользователя
  - Формирует сообщение о результате
  - Пытается сохранить карточку при успешном прохождении
  - Очищает состояние и предлагает выбрать новый раздел

- `calculate_stars` - Подсчитывает количество звезд за викторину с учетом ошибок.

- `count_stars` - Считает базовое количество звезд в зависимости от длины текста.

- `build_result_message` - Формирует текст сообщения о результате викторины.

- `try_save_card` - Пытается сохранить сгенерированную карточку пользователя.

### 3. Модуль статистики администратора (`handlers/admin/admin_general_stats.py`)

#### Основные функции:
- `show_general_stats` - Отображает общую статистику использования бота.
  - Получает статистические данные из базы данных
  - Формирует сообщение с информацией о:
    - Общем количестве пользователей
    - Количестве одобренных пользователей
    - Средней точности ответов
    - Общем количестве заработанных звезд
    - Среднем времени активности в боте
    - Количестве заданных вопросов
    - Количестве выданных карточек
  - Добавляет кнопку возврата в меню администратора

## Взаимодействие компонентов

1. Пользователь выбирает тему для чтения, что активирует `questions_handler`.
2. Бот генерирует текст и вопросы, отображает их пользователю.
3. Пользователь отвечает на вопросы, активируя `answer_handler`.
4. При завершении сессии (правильный ответ или превышение лимита ошибок) вызывается `save_card_and_notify`.
5. Функция `save_card_and_notify` обрабатывает результаты, начисляет награды и уведомляет пользователя.
6. Администраторы могут просматривать общую статистику через функцию `show_general_stats`.

## Архитектура

### Основные компоненты
- **main.py**: Точка входа, настраивает бота, middleware и роутеры
- **core/**: Основная функциональность
  - **config.py**: Константы конфигурации и таблицы
  - **database/**: Инициализация базы данных и модели
  - **services/**: Сервисы бизнес-логики
  - **middleware/**: Middleware для обработки запросов
  - **ai/**: Интеграция с ИИ для генерации текстов
  - **ui.py**: Компоненты пользовательского интерфейса
- **handlers/**: Обработчики сообщений и callback-запросов Telegram
  - **admin/**: Обработчики панели администратора
  - **reading/**: Обработчики сессий чтения
  - **cards.py**: Обработчики коллекции карточек
  - **users/**: Обработчики, связанные с пользователями

### База данных
Бот использует как SQLite (через SQLAlchemy), так и MongoDB:
- SQLite: Данные пользователей, прогресс и статистика
- MongoDB: Сгенерированные тексты, вопросы и карточки

### Интеграция с ИИ
Бот использует сервисы ИИ для генерации текстов и вопросов:
- OpenAI API для генерации текстов
- Google Gemini API (опционально) для дополнительных возможностей ИИ

## Команды пользователя
- `/reading` - Начать сессию чтения
- `/cards` - Просмотреть коллекцию карточек
- `/stats` - Просмотреть статистику
- `/withdrawal` - Проверить баланс
- `/settings` - Настроить параметры
- `/admin` - Доступ к панели администратора (только для администраторов)

## Система наград
- Пользователи получают звезды за правильные ответы
- Количество звезд зависит от длины текста и количества ошибок
- Дополнительные бонусы начисляются за серию успешных ответов
- Прогресс отслеживается по темам

## Ограничения
- Существует дневной лимит вопросов по каждой теме
- Пользователь может совершить ограниченное количество ошибок (настраивается в конфигурации)
- Доступ к боту имеют только одобренные пользователи
